<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Mesas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    input, select, button {
      margin: 5px;
      padding: 5px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>

  <h2>Gestión de Órdenes por Mesa</h2>

  <div id="mesasContainer"></div>
  <h2 id="mesaSeleccionada">Mesa seleccionada: Ninguna</h2>
  
  <style>
    .btn-mesa {
      margin: 5px;
      padding: 10px;
      background-color: #ddd;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn-mesa:hover {
      background-color: #bbb;
    }
  </style>


  <h3>Agregar orden</h3>

  <label for="nombreReceta">Nombre de receta:</label>
  <select id="nombreReceta"></select>

  <label for="idReceta">ID Receta:</label>
  <input type="text" id="idReceta" readonly>

  <label for="precio">Precio:</label>
  <input type="text" id="precio" readonly>

  <label for="cantidad">Cantidad:</label>
  <input type="number" id="cantidad" min="1" value="1">

  <button onclick="agregarOrden()">Agregar a orden</button>

  <table>
    <thead>
      <tr>
        <th>ID Orden</th>
        <th>ID Receta</th>
        <th>Nombre Receta</th>
        <th>Precio</th>
        <th>Cantidad</th>
        <th>Fecha y Hora</th>
      </tr>
    </thead>
    <tbody id="tablaOrdenes"></tbody>
  </table>

  <button onclick="enviarOrden()">Enviar orden a cocina</button>

  <script>
    let recetas = {};
    let ordenesPendientes = [];

    // Cargar recetas desde la API
    async function cargarRecetas() {
      const response = await fetch('https://backend-mesas.onrender.com/recetas');
      const data = await response.json();
      const select = document.getElementById('nombreReceta');
      data.forEach(receta => {
        recetas[receta.nombre_receta] = receta;
        const option = document.createElement('option');
        option.value = receta.nombre_receta;
        option.textContent = receta.nombre_receta;
        select.appendChild(option);
      });
      actualizarCampos();
    }

    // Actualiza los campos de ID y precio al seleccionar receta
    function actualizarCampos() {
      const nombre = document.getElementById('nombreReceta').value;
      if (recetas[nombre]) {
        document.getElementById('idReceta').value = recetas[nombre].id_receta;
        document.getElementById('precio').value = recetas[nombre].precio;
      }
    }

    document.getElementById('nombreReceta').addEventListener('change', actualizarCampos);

    // Agrega una orden localmente
    function agregarOrden() {
      const noMesa = parseInt(document.getElementById('mesa').value);
      const nombre = document.getElementById('nombreReceta').value;
      const receta = recetas[nombre];
      const cantidad = parseInt(document.getElementById('cantidad').value);
      const fechaHora = new Date().toISOString().slice(0, 19).replace('T', ' ');

      if (!receta || cantidad <= 0) return alert('Verifica los datos');

      const orden = {
        id_orden: '-', // aún no se ha insertado
        id_receta: receta.id_receta,
        nombre_receta: receta.nombre_receta,
        precio: receta.precio,
        cantidad,
        fecha_hora: fechaHora,
        no_mesa: noMesa
      };

      ordenesPendientes.push(orden);
      renderizarTabla();
    }

    // Muestra las órdenes pendientes en la tabla
    function renderizarTabla() {
      const tbody = document.getElementById('tablaOrdenes');
      tbody.innerHTML = '';
      ordenesPendientes.forEach((orden, i) => {
        const row = `
          <tr>
            <td>${orden.id_orden}</td>
            <td>${orden.id_receta}</td>
            <td>${orden.nombre_receta}</td>
            <td>${orden.precio}</td>
            <td>${orden.cantidad}</td>
            <td>${orden.fecha_hora}</td>
          </tr>`;
        tbody.innerHTML += row;
      });
    }

    // Enviar órdenes a la base de datos
    async function enviarOrden() {
      for (const orden of ordenesPendientes) {
        await fetch('https://backend-mesas.onrender.com/ordenes', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            no_mesa: orden.no_mesa,
            id_receta: orden.id_receta,
            cantidad: orden.cantidad,
            fecha_hora: orden.fecha_hora
          })
        });
      }
      alert('Orden enviada a cocina');
      ordenesPendientes = [];
      renderizarTabla();
    }

    cargarRecetas();
  </script>
</body>
</html>
