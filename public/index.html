<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Mesas y Órdenes</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 20px; }
    #listaMesas { display: flex; flex-wrap: wrap; gap: 10px; padding-left: 0; margin-bottom: 20px; }
    #listaMesas li {
      background-color: #007bff;
      color: white;
      padding: 10px 16px;
      border-radius: 5px;
      cursor: pointer;
      list-style: none;
      transition: background-color 0.2s ease;
      user-select: none;
    }
    #listaMesas li:hover { background-color: #0056b3; }
    #listaMesas li.selected { background-color: #28a745; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    input[type="text"], input[type="number"], select { padding: 5px; width: 150px; }
    button { padding: 6px 12px; margin: 2px; cursor: pointer; }
    form > div { margin-bottom: 10px; }
    #ordenesSection { display: none; }
  </style>
</head>
<body>

  <h1>Gestión de Mesas y Órdenes</h1>

  <ul id="listaMesas"></ul>

  <section id="ordenesSection">
    <h2>Órdenes de la Mesa <span id="mesaSeleccionada"></span></h2>

  <h3>Agregar orden</h3>

  <label for="nombreReceta">Nombre de receta:</label>
  <select id="nombreReceta"></select>

  <label for="idReceta">ID Receta:</label>
  <input type="text" id="idReceta" readonly>

  <label for="precio">Precio:</label>
  <input type="text" id="precio" readonly>

  <label for="cantidad">Cantidad:</label>
  <input type="number" id="cantidad" min="1" value="1">

  <button onclick="agregarOrden()">Agregar a orden</button>

  <table>
    <thead>
      <tr>
        <th>ID Orden</th>
        <th>ID Receta</th>
        <th>Nombre Receta</th>
        <th>Precio</th>
        <th>Cantidad</th>
        <th>Fecha y Hora</th>
      </tr>
    </thead>
    <tbody id="tablaOrdenes"></tbody>
  </table>

  <button onclick="enviarOrden()">Enviar orden a cocina</button>

  <script>
  const API_URL = 'https://backend-mesas.onrender.com/ordenes';
  const MESAS_URL = 'https://backend-mesas.onrender.com/mesas';
  const RECETAS_URL = 'https://backend-mesas.onrender.com/recetas';

  const listaMesas = document.getElementById('listaMesas');
  const ordenesSection = document.getElementById('ordenesSection');
  const mesaSeleccionadaSpan = document.getElementById('mesaSeleccionada');

  let mesaActual = null;

  async function cargarMesas() {
    try {
      const res = await fetch(MESAS_URL);
      const mesas = await res.json();

      listaMesas.innerHTML = '';
      mesas.forEach(mesa => {
        const numeroMesa = mesa.numero ?? mesa;
        const li = document.createElement('li');
        li.textContent = `Mesa ${numeroMesa}`;
        li.dataset.numero = numeroMesa;
        li.addEventListener('click', () => seleccionarMesa(numeroMesa));
        listaMesas.appendChild(li);
      });
    } catch (error) {
      alert('Error al cargar mesas');
      console.error(error);
    }
  }

  function seleccionarMesa(numero) {
    mesaActual = numero;
    mesaSeleccionadaSpan.textContent = numero;
    ordenesSection.style.display = 'block';
    listaMesas.style.display = 'none';

    document.querySelectorAll('#listaMesas li').forEach(li => {
      li.classList.toggle('selected', li.dataset.numero == numero);
    });
  }

  

  document.addEventListener('DOMContentLoaded', cargarMesas);
    let recetas = {};
    let ordenesPendientes = [];

    // Cargar recetas desde la API
    async function cargarRecetas() {
      const response = await fetch('https://backend-mesas.onrender.com/recetas');
      const data = await response.json();
      const select = document.getElementById('nombreReceta');
      data.forEach(receta => {
        recetas[receta.nombre_receta] = receta;
        const option = document.createElement('option');
        option.value = receta.nombre_receta;
        option.textContent = receta.nombre_receta;
        select.appendChild(option);
      });
      actualizarCampos();
    }

    // Actualiza los campos de ID y precio al seleccionar receta
    function actualizarCampos() {
      const nombre = document.getElementById('nombreReceta').value;
      if (recetas[nombre]) {
        document.getElementById('idReceta').value = recetas[nombre].id_receta;
        document.getElementById('precio').value = recetas[nombre].precio;
      }
    }

    document.getElementById('nombreReceta').addEventListener('change', actualizarCampos);

    // Agrega una orden localmente
    function agregarOrden() {
  if (!mesaActual) {
    alert('Primero selecciona una mesa');
    return;
  }

  const nombre = document.getElementById('nombreReceta').value;
  const receta = recetas[nombre];
  const cantidad = parseInt(document.getElementById('cantidad').value);
  const fechaHora = new Date().toISOString().slice(0, 19).replace('T', ' ');

  if (!receta || cantidad <= 0) {
    alert('Verifica los datos');
    return;
  }

  const orden = {
    id_orden: '-', // aún no se ha insertado
    id_receta: receta.id_receta,
    nombre_receta: receta.nombre_receta,
    precio: receta.precio,
    cantidad,
    fecha_hora: fechaHora,
    no_mesa: mesaActual
  };

  ordenesPendientes.push(orden);
  renderizarTabla();
}


    // Muestra las órdenes pendientes en la tabla
    function renderizarTabla() {
      const tbody = document.getElementById('tablaOrdenes');
      tbody.innerHTML = '';
      ordenesPendientes.forEach((orden, i) => {
        const row = `
          <tr>
            <td>${orden.id_orden}</td>
            <td>${orden.id_receta}</td>
            <td>${orden.nombre_receta}</td>
            <td>${orden.precio}</td>
            <td>${orden.cantidad}</td>
            <td>${orden.fecha_hora}</td>
          </tr>`;
        tbody.innerHTML += row;
      });
    }

    // Enviar órdenes a la base de datos
    async function enviarOrden() {
  if (!mesaActual || ordenesPendientes.length === 0) {
    alert('Selecciona una mesa y agrega al menos una orden');
    return;
  }

  for (const orden of ordenesPendientes) {
    await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        no_mesa: orden.no_mesa,
        id_receta: orden.id_receta,
        cantidad: orden.cantidad,
        fecha_hora: orden.fecha_hora
      })
    });
  }

  alert('Orden enviada a cocina');
  ordenesPendientes = [];
  renderizarTabla();
}


    cargarRecetas();
  </script>
</body>
</html>
