<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Crear / Editar Orden</title>
</head>
<body>
  <h2>Formulario de Orden</h2>

  <form id="formOrden">
    <div>
      <label for="id_receta">Producto:</label>
      <select id="id_receta" name="id_receta" required>
        <option value="" disabled selected>Selecciona un producto</option>
      </select>
    </div>

    <div>
      <label for="cantidad">Cantidad:</label>
      <input type="number" id="cantidad" name="cantidad" min="1" required />
    </div>

    <button type="submit">Guardar Orden</button>
  </form>

  <script>
    const API_URL = 'https://backend-mesas.onrender.com/ordenes';
    const API_RECETAS = 'https://backend-mesas.onrender.com/recetas';

    // Supongamos que tienes la mesa actual (de donde se está ordenando)
    // Puedes cambiar esta variable según tu lógica
    const mesaActual = 1;

    // Si editas una orden, pon aquí el id de orden, si no, null
    const idOrdenEditar = null;

    const recetaSelect = document.getElementById('id_receta');
    const cantidadInput = document.getElementById('cantidad');
    const formOrden = document.getElementById('formOrden');

    async function cargarRecetas() {
      try {
        const res = await fetch(API_RECETAS);
        if (!res.ok) throw new Error('Error al cargar recetas');
        const recetas = await res.json();

        recetaSelect.innerHTML = '<option value="" disabled selected>Selecciona un producto</option>';
        recetas.forEach(r => {
          const option = document.createElement('option');
          option.value = r.id_receta;
          option.textContent = `${r.nombre_receta} - Q${parseFloat(r.precio).toFixed(2)}`;
          recetaSelect.appendChild(option);
        });
      } catch (error) {
        alert('No se pudieron cargar los productos');
        console.error(error);
      }
    }

    formOrden.addEventListener('submit', async (e) => {
      e.preventDefault();

      const id_receta = parseInt(recetaSelect.value);
      const cantidad = parseInt(cantidadInput.value);

      if (!id_receta || cantidad < 1) {
        alert('Por favor, selecciona un producto y una cantidad válida.');
        return;
      }

      const dataOrden = {
        no_mesa: mesaActual,
        id_receta,
        cantidad
      };

      try {
        const url = idOrdenEditar ? `${API_URL}/${idOrdenEditar}` : API_URL;
        const method = idOrdenEditar ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dataOrden)
        });

        if (!res.ok) throw new Error('Error al guardar la orden');

        alert('Orden guardada con éxito');
        formOrden.reset();
        // Aquí puedes recargar la lista de órdenes o cerrar el modal, etc.

      } catch (error) {
        alert('Hubo un problema guardando la orden');
        console.error(error);
      }
    });

    // Inicializa
    cargarRecetas();
  </script>
</body>
</html>
